# 竹笛智能练习平台 v0.1 API 列表

- 生成时间：2025-12-09 16:18
- 后端框架：FastAPI
- 数据库：SQLite（当前配置），计划 MariaDB 10.11
- 基础路径：`<BASE_URL>`（本地默认 `http://localhost:8000`）
- 认证方式：OAuth2 Password（Bearer Token），除特别说明外，需在请求头携带 `Authorization: Bearer <token>`
- 静态资源：`/uploads` 挂载到 `uploads/` 目录

## 公共
- `GET /`  
  - 描述：健康检查/欢迎信息  
  - 认证：无需  
  - 返回：`{"message": "Welcome to Dizi Practice Platform API"}`

## 认证 Auth (`/auth`)
- `POST /auth/register`  
  - 描述：用户注册  
  - 请求体（JSON）：`{ "username": string, "password": string }`  
  - 认证：无需  
  - 返回：`User` 对象（`id, username, role`）

- `POST /auth/login`  
  - 描述：登录获取访问令牌  
  - 请求体（`application/x-www-form-urlencoded`）：`username`, `password`  
  - 认证：无需  
  - 返回：`{ "access_token": string, "token_type": "bearer" }`  
  - 备注：token 过期时间默认为 30 分钟

## 曲谱 Scores (`/scores`)
- `POST /scores`  
  - 描述：上传曲谱图片与伴奏音频并创建元数据  
  - 请求体（`multipart/form-data`）：  
    - 文本字段：`title`, `song_key`, `flute_key`, `fingering`, `tags`（可选，逗号分隔字符串）  
    - 文件：`image`（图片），`audio`（音频）  
  - 认证：当前未校验（未来应接入 Bearer Token）  
  - 返回：`Score` 对象（含 `id, title, song_key, flute_key, fingering, image_path, audio_path, tags`）

- `GET /scores`  
  - 描述：分页获取曲谱列表  
  - Query：`skip`（默认 0），`limit`（默认 100）  
  - 认证：无需  
  - 返回：`Score[]`

- `GET /scores/{score_id}`  
  - 描述：按 ID 获取曲谱详情  
  - 路径参数：`score_id`  
  - 认证：无需  
  - 返回：`Score`，不存在时 404

## 播放列表 Playlists (`/playlists`) —— 需 Bearer Token
- `POST /playlists`  
  - 描述：为当前用户创建播放列表  
  - 请求体（JSON）：`{ "name": string }`  
  - 返回：`Playlist`（含 `id, user_id, name, items`）

- `GET /playlists`  
  - 描述：获取当前用户的全部播放列表  
  - 返回：`Playlist[]`

- `POST /playlists/{playlist_id}/items`  
  - 描述：向播放列表添加曲目  
  - 路径参数：`playlist_id`  
  - Query 参数：`score_id`  
  - 返回：`PlaylistItem`（含 `id, playlist_id, score_id, sort_order`）；列表或曲谱不存在时返回 404

## 录音 Recordings (`/recordings`) —— 需 Bearer Token
- `POST /recordings`  
  - 描述：上传用户录制文件并关联曲谱  
  - 请求体（`multipart/form-data`）：`score_id`（form 字段），`file`（录音文件）  
  - 返回：`Recording`（含 `id, user_id, score_id, file_path`）；若 `score_id` 无效返回 404

- `GET /recordings`  
  - 描述：获取当前用户的录音列表  
  - 返回：`Recording[]`

## 调试 Debug (`/debug`)
- `POST /debug/log`  
  - 描述：收集前端调试日志（音频上下文、音高调试等）  
  - 请求体（JSON）：`{ timestamp, userAgent, audioContext, pitchInfo?, rawBuffer?, message? }`  
  - 认证：无需  
  - 返回：`{ status: "ok", saved_to: "debug_logs.jsonl" }`

- `GET /debug/logs`  
  - 描述：拉取最近调试日志  
  - Query：`limit`（默认 10，返回最新 N 条）  
  - 认证：无需  
  - 返回：日志对象数组（从 `debug_logs.jsonl` 读取）

## 数据模型（响应骨架）
- `User`：`id, username, role`
- `Score`：`id, title, song_key, flute_key, fingering, image_path, audio_path, tags[]`
- `Playlist`：`id, user_id, name, items: PlaylistItem[]`
- `PlaylistItem`：`id, playlist_id, score_id, sort_order, score?`
- `Recording`：`id, user_id, score_id, file_path`

## 后续改进建议
- 为 `/scores` 的创建接口补充鉴权与角色检查（管理员/作者）。  
- `tags` 建议改为 JSON 数组输入，前后端对齐。  
- `playlist items` 与 `recordings` 建议增加删除、更新接口。  
- 将敏感配置（JWT 密钥、数据库连接）迁移到环境变量，并提供 `env.example`。  

