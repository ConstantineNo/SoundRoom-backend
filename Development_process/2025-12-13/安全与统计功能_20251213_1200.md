# 安全与统计功能设计文档

## 1. 功能概述
本项目新增了访客统计与安全防御功能，旨在保护后端服务免受恶意攻击，并记录访客行为数据。

## 2. 核心模块

### 2.1 安全服务 (SecurityService)
- **限流 (Rate Limiting)**: 
  - 策略：单IP每秒最多 50 次请求，每分钟最多 60 次请求。
  - 实现：基于内存的滑动窗口算法。
  - 处罚：触发限流后封禁 IP 60 分钟。
- **敏感路径检测 (Sensitive Path Detection)**:
  - 策略：检测对 `.env`, `wp-admin` 等不存在文件的扫描。
  - 阈值：连续 5 次 404 错误且路径在敏感列表中。
  - 处罚：永久封禁（或需手动解封）。
- **IP 封禁**:
  - 数据库记录：`banned_ips` 表记录封禁原因和过期时间。
  - 系统层拦截：尝试调用 `iptables` 直接丢弃数据包（需 Root 权限）。

### 2.2 统计服务 (StatsService)
- **地理位置**: 使用 GeoIP2 离线库解析 IP 对应的城市/国家。
- **设备分析**: 解析 User-Agent 获取设备类型（手机/PC）、操作系统、浏览器。
- **数据存储**:
  - `visitor_logs`: 详细的单次访问记录。
  - `daily_stats`: 按天聚合的 PV/UV 和热门 URL 统计。

### 2.3 中间件 (SecurityMiddleware)
- 位于 CORS 中间件内部（被 CORS 包裹），确保安全拦截优先于业务逻辑。
- 异步记录日志，不阻塞主请求流程。

## 3. 数据库设计

### VisitorLog
| 字段 | 类型 | 说明 |
|Data | Type | Description|
|---|---|---|
| ip_address | String | 访客IP |
| country | String | 国家 |
| city | String | 城市 |
| device_type | String | mobile/pc/tablet |
| request_path | String | 请求路径 |

### DailyStats
| 字段 | 类型 | 说明 |
|---|---|---|
| date | Date | 日期 |
| pv | Integer | 页面浏览量 |
| uv | Integer | 独立访客数 |
| top_urls | JSON | 热门路径统计 |

### BannedIP
| 字段 | 类型 | 说明 |
|---|---|---|
| ip_address | String | 被封禁IP |
| reason | String | 封禁原因 |
| expires_at | DateTime | 过期时间 |

## 4. 配置说明
在 `app/core/config.py` 中配置：
- `WHITELIST_IPS`: 白名单 IP 列表
- `GEOIP_DB_PATH`: GeoIP 数据库路径
